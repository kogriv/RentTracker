# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
## Автоматизация отслеживания оплат аренды гаражей и уведомления о просрочках

---

## 1. ОБЩЕЕ ОПИСАНИЕ СИСТЕМЫ

**Цель:** Создать автоматизированную систему для отслеживания своевременности оплаты аренды гаражей с возможностью формирования отчетов о статусах платежей.

**Основные функции:**
- Парсинг банковских выписок различных форматов
- Сопоставление платежей с арендными обязательствами
- Расчет плановых дат оплаты с учетом особенностей календаря
- Определение статусов платежей и просрочек (оплачен, просрочен, ожидается и т.д.)
- Формирование детальных отчетов в формате Excel по всем объектам аренды

---

## 2. АНАЛИЗ ИСХОДНЫХ ДАННЫХ

### 2.1 Справочник гаражей (`arenda.xlsx`) (*Справочник арендных обязательств*)

**Структура файла:**
| Колонка | Тип | Описание |
|---------|-----|----------|
| `Гараж` | Число/Текст | Уникальный идентификатор гаража (1-15) |
| `Сумма` | Число | Ежемесячная арендная плата в рублях. Предполагается, что  каждая сумма должна быть уникальной, так как она используется как основной идентификатор платежа. |
| `Первоначальная дата` | Дата | Базовая дата для расчета ежемесячных платежей для всех последующих месяцев |

**Выявленные особенности по факту:**
- 15 гаражей с суммами от 2390 до 4750 рублей
- **КРИТИЧЕСКАЯ ПРОБЛЕМА:** Сумма 3500 руб. дублируется у гаражей №6 и №13
- Первоначальные даты разбросаны по разным дням месяца (1, 2, 3, 5, 7, 8, 9, 14, 18, 22 числа)
- Различные месяцы начала аренды (от февраля 2024 до апреля 2025)

**Принятые решения:**
- Поле "Имя арендатора" отсутствует → система работает только с номерами гаражей
- Периодичность оплаты: **ежемесячно** по умолчанию
- Идентификация по уникальной сумме + временному окну

### 2.2 Банковская выписка (`print 2.xlsx`)

**Фактическая структура:**
Рассматривается как "сырой" источник данных о фактических денежных поступлениях.  
- Многостраничная выписка (289 строк данных)
- Период: 01.05.2025 - 12.06.2025
- Формат операций: "Перевод на карту", "Перевод СБП"
- Найдено 66 входящих транзакций

**Структура данных для парсинга:**
| Колонка A | Колонка B | Колонка C | Колонка D | Колонка E |
|-----------|-----------|-----------|-----------|-----------|
| `дд.мм.гггг чч:мм` | Время | - | Категория операции | `+X XXX,XX` |

**Результаты сопоставления:**
- 10 из 14 арендных сумм имеют точные совпадения в выписке
- Не найдены: 3500, 2600, 2990, 2799 руб.
- Некоторые суммы встречаются по 2 раза (ежемесячные платежи)

---

## 3. МОДУЛЬ ПАРСИНГА БАНКОВСКОЙ ВЫПИСКИ

### 3.1 Алгоритм извлечения транзакций
**Особенности и правила парсинга:**

- Нестабильный формат: Система не должна зависеть от конкретных номеров строк или столбцов.
- Поиск транзакций: Модуль парсинга должен построчно сканировать файл и идентифицировать строки с операциями по следующим признакам:
   - Строка начинается с даты в формате ДД.ММ.ГГГГ.
   - В строке присутствует сумма поступления (числовое значение с префиксом +, например, +3 500,00).
- Извлечение данных: Из найденной строки извлекаются дата и сумма операции. Сумма очищается от нечисловых символов для дальнейшего сравнения.
- Обработка переносов: Модуль должен уметь находить сумму платежа как в той же строке, что и дата, так и в нескольких строках ниже, чтобы обрабатывать возможные переносы строк в выписке.
- Игнорирование: Все строки, не являющиеся операциями поступления (заголовки, подписи, служебная информация), игнорируются.

**Критерии идентификации строк с операциями:**
1. Поиск строк с датой в формате `дд.мм.гггг` в колонке A
2. Наличие суммы с префиксом `+` в колонке E
3. Категория операции содержит "Перевод" (на карту/СБП)

**Алгоритм очистки данных:**
```
1. Извлечь дату операции из колонки A (первые 10 символов)
2. Извлечь сумму из колонки E:
   - Убрать символ "+"
   - Убрать все пробелы
   - Заменить запятую на точку
   - Преобразовать в число
3. Извлечь категорию операции из колонки D
4. Валидировать полученные данные
```

### 3.2 Адаптивность к изменениям формата

**Гибкие паттерны поиска:**
- Дата: `/^\d{2}\.\d{2}\.\d{4}/`
- Сумма: `/\+.*?(\d[\d\s,]*\d|\d),\d{2}/`
- Категория: поиск по ключевым словам ("Перевод", "СБП", "карту")

**Обработка многостраничности:**
- Автоматическое обнаружение служебных строк (заголовки, QR-коды)
- Пропуск строк "Продолжение на следующей странице"
- Поиск маркеров "Страница X из Y"

---

## 4. ЛОГИКА РАСЧЕТА ПЛАНОВЫХ ДАТ

### 4.1 Интерпретация базовой даты

**Принятый подход:** День из "Первоначальной даты" используется как день месяца для всех последующих платежей.

**Алгоритм расчета ожидаемой даты:**
```
1. Извлечь день месяца из базовой даты (например, 5 число)
2. Для текущего/проверяемого месяца:
   - Если в месяце есть такой день → использовать его
   - Если день больше количества дней в месяце → последний день месяца
3. Учесть особые случаи:
   - 29 февраля в невисокосный год → 28 февраля
   - 30-31 число в коротких месяцах → последний день
```

### 4.2 Примеры расчета (на основе реальных данных)

- Гараж №1 (дата: 01.01.2025) → ожидаемая оплата каждое 1 число месяца
- Гараж №3 (дата: 01.02.2025) → ожидаемая оплата каждое 1 число месяца  
- Гараж №9 (дата: 18.03.2025) → ожидаемая оплата каждое 18 число месяца
- Гараж №11 (дата: 22.04.2025) → ожидаемая оплата каждое 22 число месяца

---

## 5. СОПОСТАВЛЕНИЕ ПЛАТЕЖЕЙ

### 5.1 Критерии идентификации платежа

**Основной критерий:** Точное совпадение суммы платежа из выписки с суммой из справочника.

**Временное окно поиска:** ±7 дней от расчетной даты платежа (расширенное для учета задержек и авансов).

**Алгоритм сопоставления:**
```
1. Для каждого гаража рассчитать ожидаемую дату оплаты
2. Найти в выписке все платежи с точной суммой
3. Из найденных выбрать ближайший по дате к ожидаемой
4. Исключить уже использованные платежи
5. Обработать особые случаи (дубликаты, множественные совпадения)
```

### 5.2 Обработка проблемных ситуаций

**Дублирующие суммы аренды:**
- **Проблема:** Гаражи №6 и №13 имеют одинаковую сумму 3500 руб.
- **Решение:** Приоритет по близости к расчетной дате + логирование конфликта

**Повторяющиеся платежи:**
- **Ситуация:** Одна сумма встречается несколько раз в выписке
- **Решение:** Распределение по хронологии (май → июнь)

**Отсутствующие платежи:**
- **Факт:** 4 суммы не найдены в выписке (3500, 2600, 2990, 2799)
- **Обработка:** Статус "просрочен" или "не найден"

---

## 6. КЛАССИФИКАЦИЯ СТАТУСОВ ПЛАТЕЖЕЙ

### 6.1 Определения статусов

| Статус | Условие | Описание |
|--------|---------|-----------|
| **"Получен"** | Найден точный платеж в окне [расчетная_дата - 7 дней; расчетная_дата + 3 дня] | Оплата поступила своевременно |
| **"Просрочен"** | Текущая дата > расчетная_дата + 3 дня И платеж не найден | Превышен льготный период |
| **"Срок не наступил"** | Текущая дата < расчетная_дата | Время оплаты еще не подошло |
| **"Ожидается оплата"** | Расчетная_дата ≤ текущая дата ≤ расчетная_дата + 3 дня И платеж не найден | В пределах льготного периода |
| **"Неопределенно"** | Найдено несколько подходящих платежей | Требует ручной проверки |

### 6.2 Дополнительная аналитика

**Расчетные поля:**
- Количество дней просрочки (если > 0)
- Разница между фактической и ожидаемой датой оплаты
- Следующая плановая дата оплаты
- Примечания о найденных альтернативах

---

## 7. Формат и содержание итогового отчета
По итогам проверки система формирует единый .xlsx файл.

Структура отчета:
| Название колонки | Описание |
|------|-----------|
| Номер гаража | Идентификатор из справочника. |
| Арендная плата (руб.) | Сумма из справочника. |
| Ожидаемая дата оплаты	| Расчетная дата для текущего периода. |
| Фактическая дата оплаты |	Дата поступления средств из выписки (если платеж найден). |
| Статус платежа | Один из статусов: "Получен", "Просрочен", "Ожидается оплата", "Срок не наступил". |
| Дней просрочки |	Количество дней, прошедших с конца льготного периода (заполняется для статуса "Просрочен"). |
| Примечания |	Дополнительная информация (например, какой платеж был зачтен). |


## 8. ТЕХНИЧЕСКАЯ РЕАЛИЗАЦИЯ

### 7.1 Модульная архитектура

Ниже - вариант (не обязательное условие) состава компонентов приложения.

**Основные компоненты:**
1. **FileParser** - чтение и парсинг Excel файлов
2. **TransactionExtractor** - извлечение операций из выписки  
3. **PaymentMatcher** - сопоставление платежей с обязательствами
4. **DateCalculator** - расчет плановых дат с учетом календаря
5. **StatusDeterminer** - определение статусов платежей
6. **ReportGenerator** - формирование выходных отчетов

### 7.2 Обработка ошибок и валидация

**Входная валидация:**
- Проверка структуры файлов (наличие обязательных колонок)
- Валидация дат и сумм
- Проверка уникальности арендных сумм
- Контроль корректности периода вы