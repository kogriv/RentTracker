# Обработка проблемных ситуаций в Garage Payment Tracker

## Обзор

Данный документ описывает, как система Garage Payment Tracker обрабатывает сложные ситуации при сопоставлении платежей с ожидаемыми арендными платами.

## 1. Дублирующие суммы аренды

### Проблема
Гаражи №6 и №13 имеют одинаковую сумму аренды 3500 руб. При наличии одной транзакции на эту сумму возникает неопределенность: какому гаражу ее присвоить?

### Реализованное решение

**Обнаружение конфликтов:**
- Функция `_find_amount_conflicts()` сканирует все гаражи и создает карту сумм
- Если для одной суммы найдено более одного гаража - это конфликт
- Возвращается словарь: `{3500: ['6', '13']}`

**Разрешение конфликтов:**
- При поиске транзакции система получает список конфликтующих гаражей
- Если найдена одна подходящая транзакция - она принимается, но в примечания добавляется предупреждение: "Amount conflict with garages: 6, 13"
- **Важно:** система работает последовательно по списку гаражей, поэтому первый обработанный гараж получит транзакцию, второй останется без платежа

**Логирование:**
- Конфликт записывается в notes платежа
- WARNING логируется в консоль и файл: "Duplicate rental amount 3500: garages 6, 13"

### Текущие ограничения

**❌ НЕ реализован приоритет по близости к расчетной дате**

Система использует принцип **"первый пришел - первый получил"**:

1. **Последовательная обработка гаражей** - в порядке следования в Excel файле
2. **Первый забирает транзакцию** - когда доходит очередь до первого гаража с суммой 3500, он забирает подходящую транзакцию
3. **Второй остается без платежа** - второй гараж с той же суммой находит транзакцию уже использованной

**Пример неоптимального распределения:**
- Гараж №6 ожидает платеж 1 мая, гараж №13 - 15 мая  
- Есть транзакция 3500 руб от 14 мая
- Система отдаст ее гаражу №6 (отклонение 13 дней) вместо гаража №13 (отклонение 1 день)

## 2. Повторяющиеся платежи

### Ситуация
Одна сумма встречается несколько раз в банковской выписке в разные даты.

### Реализованное решение

**Обнаружение множественных совпадений:**
- При поиске в временном окне находится несколько подходящих транзакций

**Стратегия разрешения - приоритет по близости к расчетной дате:**
```python
best_transaction = min(candidates, 
                     key=lambda t: abs((t.date - expected_date).days))
```
- Выбирается транзакция, ближайшая по дате к ожидаемой дате платежа

**Защита от повторного использования:**
- Используется набор `used_transactions`
- Каждая использованная транзакция помечается по ID объекта
- Повторное использование исключено проверкой `id(transaction) not in used_transactions`

**Логирование:**
- В notes записывается: "Multiple matches found, selected closest to expected date"
- При наличии конфликта сумм: "Multiple matches found, selected closest to expected date. Amount conflict with garages: ..."

### ✅ Работает корректно
Приоритет по близости к расчетной дате работает только для **множественных транзакций для ОДНОГО гаража**.

## 3. Хронологическое распределение (май → июнь)

### Текущая реализация
Проект **НЕ реализует** автоматическое распределение по месяцам.

**Вместо этого:**
- Каждый анализ работает только с одним целевым месяцем
- `DateCalculator` вычисляет ожидаемую дату для конкретного месяца
- Транзакции фильтруются по дате анализа (до указанной даты включительно)
- Для обработки разных месяцев нужны отдельные запуски с разными analysis_date

## Ключевые принципы архитектуры

1. **"Жадный" алгоритм** - первый подходящий гараж забирает транзакцию
2. **Иммутабельность транзакций** - каждая используется только один раз
3. **Прозрачность конфликтов** - все проблемы логируются и отображаются
4. **Временные окна** - поиск ограничен разумными рамками (±7/+3 дня)
5. **Fallback механизм** - если в узком окне ничего не найдено, расширяется поиск на весь период

## Потенциальные улучшения

### Для дублирующих сумм:
- Глобальный анализ всех конфликтов перед распределением
- Оптимальное сопоставление по минимальному отклонению дат
- Алгоритм "венгерского метода" для оптимального назначения

### Для хронологического распределения:
- Автоматическое определение месяца платежа по дате транзакции
- Интеллектуальное распределение между смежными периодами
- Поддержка обработки нескольких месяцев в одном запуске

## Заключение

Система спроектирована для обработки реальных банковских данных с их неизбежными конфликтами и неоднозначностями. Текущие алгоритмы работают достаточно хорошо для большинства случаев, но могут быть улучшены для более оптимального распределения в сложных ситуациях.